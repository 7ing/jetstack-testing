periodics:

- name: ci-cert-manager-previous-bazel
  interval: 2h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8 # still required on 1.8 because some tests were only present in bazel
  labels:
    preset-service-account: "true"
    preset-bazel-remote-cache-enabled: "true"
    preset-bazel-scratch-dir: "true"
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs 'bazel test --jobs=1 //...'
  spec:
    containers:
    - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
      args:
      - runner
      - bazel
      - test
      - --jobs=1
      - //...
      resources:
        requests:
          cpu: 2
          memory: 4Gi
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-previous-make-test
  interval: 2h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  labels:
    preset-service-account: "true"
    preset-make-volumes: "true"
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    description: Runs unit and integration tests # NB: for release-1.9, add "and verification scripts" to the end here
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args: # NB: for release-1.9 onwards, we'll also want to run the ci-presubmit target here, but that work is done by bazel for 1.8
        - runner
        - make
        - -j
        - vendor-go
        - test-ci
        resources:
          requests:
            cpu: 2
            memory: 4Gi
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-upgrade-previous
  interval: 8h
  agent: kubernetes
  decorate: true
  # extra refs specify what repo should be cloned
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs cert-manager upgrade test
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - make
        - cluster
        - verify_upgrade
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"

### E2E tests against all supported Kubernetes versions with all cert-manager alpha/beta feature gates enabled ###

- name: ci-cert-manager-previous-e2e-v1-19
  interval: 2h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.19 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-bazel-remote-cache-enabled: "true"
    preset-bazel-scratch-dir: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
    preset-ginkgo-skip-default: "true"
    preset-default-e2e-volumes: "true"
    preset-make-volumes: "true"
  spec:
    containers:
    - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
      args:
      - runner
      - make
      - -j
      - vendor-go
      - e2e-ci
      - K8S_VERSION=1.19
      resources:
        requests:
          cpu: 3500m
          memory: 12Gi
      securityContext:
        privileged: true
        capabilities:
          add: ["SYS_ADMIN"]
    dnsConfig:
      options:
      - name: ndots
        value: "1"

- name: ci-cert-manager-previous-e2e-v1-20
  interval: 2h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.20 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-bazel-remote-cache-enabled: "true"
    preset-bazel-scratch-dir: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
    preset-ginkgo-skip-default: "true"
    preset-default-e2e-volumes: "true"
    preset-make-volumes: "true"
  spec:
    containers:
    - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
      args:
      - runner
      - make
      - -j
      - vendor-go
      - e2e-ci
      - K8S_VERSION=1.20
      resources:
        requests:
          cpu: 3500m
          memory: 12Gi
      securityContext:
        privileged: true
        capabilities:
          add: ["SYS_ADMIN"]
    dnsConfig:
      options:
      - name: ndots
        value: "1"

- name: ci-cert-manager-previous-e2e-v1-21
  interval: 2h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.21 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-bazel-remote-cache-enabled: "true"
    preset-bazel-scratch-dir: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
    preset-ginkgo-skip-default: "true"
    preset-default-e2e-volumes: "true"
    preset-make-volumes: "true"
  spec:
    containers:
    - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
      args:
      - runner
      - make
      - -j
      - vendor-go
      - e2e-ci
      - K8S_VERSION=1.21
      resources:
        requests:
          cpu: 3500m
          memory: 12Gi
      securityContext:
        privileged: true
        capabilities:
          add: ["SYS_ADMIN"]
    dnsConfig:
      options:
      - name: ndots
        value: "1"

- name: ci-cert-manager-previous-e2e-v1-22
  interval: 2h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.22 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-bazel-remote-cache-enabled: "true"
    preset-bazel-scratch-dir: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
    preset-ginkgo-skip-default: "true"
    preset-default-e2e-volumes: "true"
    preset-make-volumes: "true"
  spec:
    containers:
    - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
      args:
      - runner
      - make
      - -j
      - vendor-go
      - e2e-ci
      - K8S_VERSION=1.22
      resources:
        requests:
          cpu: 3500m
          memory: 12Gi
      securityContext:
        privileged: true
        capabilities:
          add: ["SYS_ADMIN"]
    dnsConfig:
      options:
      - name: ndots
        value: "1"

- name: ci-cert-manager-previous-e2e-v1-23
  interval: 2h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.23 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-bazel-remote-cache-enabled: "true"
    preset-bazel-scratch-dir: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
    preset-ginkgo-skip-default: "true"
    preset-default-e2e-volumes: "true"
    preset-make-volumes: "true"
  spec:
    containers:
    - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
      args:
      - runner
      - make
      - -j
      - vendor-go
      - e2e-ci
      - K8S_VERSION=1.23
      resources:
        requests:
          cpu: 3500m
          memory: 12Gi
      securityContext:
        privileged: true
        capabilities:
          add: ["SYS_ADMIN"]
    dnsConfig:
      options:
      - name: ndots
        value: "1"

- name: ci-cert-manager-previous-e2e-v1-24
  interval: 2h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.24 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-bazel-remote-cache-enabled: "true"
    preset-bazel-scratch-dir: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
    preset-ginkgo-skip-default: "true"
    preset-default-e2e-volumes: "true"
    preset-make-volumes: "true"
  spec:
    containers:
    - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
      args:
      - runner
      - make
      - -j
      - vendor-go
      - e2e-ci
      - K8S_VERSION=1.24
      resources:
        requests:
          cpu: 3500m
          memory: 12Gi
      securityContext:
        privileged: true
        capabilities:
          add: ["SYS_ADMIN"]
    dnsConfig:
      options:
      - name: ndots
        value: "1"

# This periodic is here to temporarily test release-1.7 against Kubernetes 1.24
# to verify that it works as we have not tested with 1.24 coming up to releasing
# 1.7. Remove this job altogether when removing tests for 1.7
- name: ci-cert-manager-previous-previous-e2e-v1-24
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.7
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.24 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-bazel-remote-cache-enabled: "true"
    preset-bazel-scratch-dir: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
    preset-ginkgo-skip-default: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
    - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
      args:
      - runner
      - devel/ci-run-e2e.sh
      env:
      - name: K8S_VERSION
        value: "1.24"
      resources:
        requests:
          cpu: 3500m
          memory: 12Gi
      securityContext:
        privileged: true
        capabilities:
          add: ["SYS_ADMIN"]
    dnsConfig:
      options:
      - name: ndots
        value: "1"


### E2E tests against all supported Kubernetes versions with all cert-manager alpha/beta feature gates disabled ###

- name: ci-cert-manager-e2e-feature-gates-disabled-v1-19-previous
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.19 cluster with all feature gates disabled
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-beta-feature-gates: "true"
    preset-retry-flakey-tests: "true"
    preset-make-volumes: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - make
        - -j
        - vendor-go
        - e2e-ci
        - K8S_VERSION=1.19
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-e2e-feature-gates-disabled-v1-20-previous
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.20 cluster with all feature gates disabled
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-beta-feature-gates: "true"
    preset-retry-flakey-tests: "true"
    preset-make-volumes: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - make
        - -j
        - vendor-go
        - e2e-ci
        - K8S_VERSION=1.20
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-e2e-feature-gates-disabled-v1-21-previous
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.21 cluster with all feature gates disabled
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-beta-feature-gates: "true"
    preset-retry-flakey-tests: "true"
    preset-make-volumes: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - make
        - -j
        - vendor-go
        - e2e-ci
        - K8S_VERSION=1.21
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-e2e-feature-gates-disabled-v1-22-previous
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.22 cluster with all feature gates disabled
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-beta-feature-gates: "true"
    preset-retry-flakey-tests: "true"
    preset-make-volumes: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - make
        - -j
        - vendor-go
        - e2e-ci
        - K8S_VERSION=1.22
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-e2e-feature-gates-disabled-v1-23-previous
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.23 cluster with all feature gates disabled
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-beta-feature-gates: "true"
    preset-retry-flakey-tests: "true"
    preset-make-volumes: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - make
        - -j
        - vendor-go
        - e2e-ci
        - K8S_VERSION=1.23
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-e2e-feature-gates-disabled-v1-24-previous
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.24 cluster with all feature gates disabled
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-beta-feature-gates: "true"
    preset-retry-flakey-tests: "true"
    preset-make-volumes: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - make
        - -j
        - vendor-go
        - e2e-ci
        - K8S_VERSION=1.24
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"

# This periodic is here to temporarily test release-1.7 against Kubernetes 1.24
# to verify that it works as we have not tested with 1.24 coming up to releasing
# 1.7. Remove this job altogether when removing tests for 1.7
- name: ci-cert-manager-e2e-feature-gates-disabled-v1-24-previous-prev
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.7
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.24 cluster with all feature gates disabled
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-beta-feature-gates: "true"
    preset-retry-flakey-tests: "true"
    preset-default-e2e-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - devel/ci-run-e2e.sh
        env:
        - name: K8S_VERSION
          value: "1.24"
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"

##### E2E tests that don't run as part of normal test run #####

# This test runs Venafi (VaaS and TPP) tests.
# This is the only CI test job that runs those.
- name: ci-cert-manager-previous-venafi
  interval: 24h
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.8
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-previous
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs e2e tests for Venafi issuer
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-venafi-cloud-credentials: "true"
    preset-venafi-tpp-credentials: "true"
    preset-ginkgo-focus-venafi: "true"
    preset-default-e2e-volumes: "true"
    preset-make-volumes: "true"
  spec:
    containers:
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20220512-b6ea825-4.2.1
        args:
        - runner
        - make
        - -j
        - vendor-go
        - e2e-ci
        - K8S_VERSION=1.23
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
    dnsConfig:
      options:
        - name: ndots
          value: "1"
