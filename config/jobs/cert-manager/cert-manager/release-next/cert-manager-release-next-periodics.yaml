# These tests are configured to only run weekly for now.
# Why? Because there's no point testing the release-1.9 branch until we do the first 1.9 release: 1.9.0-alpha.0
# See Step 13.3 in https://cert-manager.io/docs/contributing/release-process/
#
periodics:
- name: ci-cert-manager-next-bazel
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  labels:
    preset-service-account: "true"
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-next
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs 'make test-ci'
    spec:
      containers:
        # TODO: change to a custom image that embeds the system tools we
        # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
        # https://github.com/cert-manager/cert-manager/issues/4939.
        - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
          args:
            - runner
            - bash
            - -c
            - |
              apt-get install jq -y >/dev/null
              make -j vendor-go test-ci
          resources:
            requests:
              cpu: 2
              memory: 4Gi
          volumeMounts:
            - mountPath: /root/.cache/go-build
              name: gocache
            - mountPath: /home/prow/go/pkg/mod
              name: gopkgmod
            - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
              name: bindownloaded
      volumes:
        - name: gocache
          hostPath:
            path: /tmp/gocache
            type: DirectoryOrCreate
        - name: gopkgmod
          hostPath:
            path: /tmp/gopkgmod
            type: DirectoryOrCreate
        - name: bindownloaded
          hostPath:
            path: /tmp/bindownloaded
            type: DirectoryOrCreate
      dnsConfig:
        options:
          - name: ndots
            value: "1"

- name: ci-cert-manager-next-e2e-v1-18
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-next
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.18 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-feature-gates: "true"
  spec:
    containers:
      # TODO: change to a custom image that embeds the system tools we
      # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
      # https://github.com/cert-manager/cert-manager/issues/4939.
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
        args:
          - runner
          - bash
          - -c
          - |
            apt-get install jq -y >/dev/null
            make -j vendor-go e2e-ci K8S_VERSION=1.18
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /root/.cache/go-build
            name: gocache
          - mountPath: /home/prow/go/pkg/mod
            name: gopkgmod
          - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
            name: bindownloaded
    volumes:
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: gocache
        hostPath:
          path: /tmp/gocache
          type: DirectoryOrCreate
      - name: gopkgmod
        hostPath:
          path: /tmp/gopkgmod
          type: DirectoryOrCreate
      - name: bindownloaded
        hostPath:
          path: /tmp/bindownloaded
          type: DirectoryOrCreate
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-next-e2e-v1-19
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-next
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.19 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
  spec:
    containers:
      # TODO: change to a custom image that embeds the system tools we
      # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
      # https://github.com/cert-manager/cert-manager/issues/4939.
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
        args:
          - runner
          - bash
          - -c
          - |
            apt-get install jq -y >/dev/null
            make -j vendor-go e2e-ci K8S_VERSION=1.19
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /root/.cache/go-build
            name: gocache
          - mountPath: /home/prow/go/pkg/mod
            name: gopkgmod
          - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
            name: bindownloaded
    volumes:
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: gocache
        hostPath:
          path: /tmp/gocache
          type: DirectoryOrCreate
      - name: gopkgmod
        hostPath:
          path: /tmp/gopkgmod
          type: DirectoryOrCreate
      - name: bindownloaded
        hostPath:
          path: /tmp/bindownloaded
          type: DirectoryOrCreate
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-next-e2e-v1-20
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-next
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.20 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
  spec:
    containers:
      # TODO: change to a custom image that embeds the system tools we
      # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
      # https://github.com/cert-manager/cert-manager/issues/4939.
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
        args:
          - runner
          - bash
          - -c
          - |
            apt-get install jq -y >/dev/null
            make -j vendor-go e2e-ci K8S_VERSION=1.20
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /root/.cache/go-build
            name: gocache
          - mountPath: /home/prow/go/pkg/mod
            name: gopkgmod
          - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
            name: bindownloaded
    volumes:
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: gocache
        hostPath:
          path: /tmp/gocache
          type: DirectoryOrCreate
      - name: gopkgmod
        hostPath:
          path: /tmp/gopkgmod
          type: DirectoryOrCreate
      - name: bindownloaded
        hostPath:
          path: /tmp/bindownloaded
          type: DirectoryOrCreate
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-next-e2e-v1-21
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-next
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.21 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-feature-gates: "true"
  spec:
    containers:
      # TODO: change to a custom image that embeds the system tools we
      # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
      # https://github.com/cert-manager/cert-manager/issues/4939.
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
        args:
          - runner
          - bash
          - -c
          - |
            apt-get install jq -y >/dev/null
            make -j vendor-go e2e-ci K8S_VERSION=1.21
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /root/.cache/go-build
            name: gocache
          - mountPath: /home/prow/go/pkg/mod
            name: gopkgmod
          - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
            name: bindownloaded
    volumes:
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: gocache
        hostPath:
          path: /tmp/gocache
          type: DirectoryOrCreate
      - name: gopkgmod
        hostPath:
          path: /tmp/gopkgmod
          type: DirectoryOrCreate
      - name: bindownloaded
        hostPath:
          path: /tmp/bindownloaded
          type: DirectoryOrCreate
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-next-e2e-v1-22
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-next
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.22 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-disable-all-alpha-feature-gates: "true"
  spec:
    containers:
      # TODO: change to a custom image that embeds the system tools we
      # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
      # https://github.com/cert-manager/cert-manager/issues/4939.
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
        args:
          - runner
          - bash
          - -c
          - |
            apt-get install jq -y >/dev/null
            make -j vendor-go e2e-ci K8S_VERSION=1.22
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /root/.cache/go-build
            name: gocache
          - mountPath: /home/prow/go/pkg/mod
            name: gopkgmod
          - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
            name: bindownloaded
    volumes:
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: gocache
        hostPath:
          path: /tmp/gocache
          type: DirectoryOrCreate
      - name: gopkgmod
        hostPath:
          path: /tmp/gopkgmod
          type: DirectoryOrCreate
      - name: bindownloaded
        hostPath:
          path: /tmp/bindownloaded
          type: DirectoryOrCreate
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-next-e2e-v1-23
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-next
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs the end-to-end test suite against a Kubernetes v1.23 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-cloudflare-credentials: "true"
    preset-enable-all-feature-gates: "true"
  spec:
    containers:
      # TODO: change to a custom image that embeds the system tools we
      # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
      # https://github.com/cert-manager/cert-manager/issues/4939.
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
        args:
          - runner
          - bash
          - -c
          - |
            apt-get install jq -y >/dev/null
            make -j vendor-go e2e-ci K8S_VERSION=1.23
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /root/.cache/go-build
            name: gocache
          - mountPath: /home/prow/go/pkg/mod
            name: gopkgmod
          - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
            name: bindownloaded
    volumes:
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: gocache
        hostPath:
          path: /tmp/gocache
          type: DirectoryOrCreate
      - name: gopkgmod
        hostPath:
          path: /tmp/gopkgmod
          type: DirectoryOrCreate
      - name: bindownloaded
        hostPath:
          path: /tmp/bindownloaded
          type: DirectoryOrCreate
    dnsConfig:
      options:
        - name: ndots
          value: "1"

# This test runs Venafi (VaaS and TPP) tests
# This is the only CI test job that runs those.
- name: ci-cert-manager-next-venafi
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-master
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs Venafi (VaaS and TPP) e2e tests against Kubernetes v1.23 cluster
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
    preset-venafi-cloud-credentials: "true"
    preset-venafi-tpp-credentials: "true"
    preset-ginkgo-focus-venafi: "true"
  spec:
    containers:
      # TODO: change to a custom image that embeds the system tools we
      # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
      # https://github.com/cert-manager/cert-manager/issues/4939.
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
        args:
          - runner
          - bash
          - -c
          - |
            apt-get install jq -y >/dev/null
            make -j vendor-go e2e-ci K8S_VERSION=1.23
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /root/.cache/go-build
            name: gocache
          - mountPath: /home/prow/go/pkg/mod
            name: gopkgmod
          - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
            name: bindownloaded
    volumes:
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: gocache
        hostPath:
          path: /tmp/gocache
          type: DirectoryOrCreate
      - name: gopkgmod
        hostPath:
          path: /tmp/gopkgmod
          type: DirectoryOrCreate
      - name: bindownloaded
        hostPath:
          path: /tmp/bindownloaded
          type: DirectoryOrCreate
    dnsConfig:
      options:
        - name: ndots
          value: "1"

- name: ci-cert-manager-next-upgrade
  interval: 168h # 1 week
  agent: kubernetes
  decorate: true
  # extra refs specify what repo should be cloned
  extra_refs:
  - org: cert-manager
    repo: cert-manager
    base_ref: release-1.9
  annotations:
    testgrid-create-test-group: 'true'
    testgrid-dashboards: jetstack-cert-manager-master
    testgrid-alert-email: cert-manager-dev-alerts@googlegroups.com
    description: Runs cert-manager upgrade test.
  labels:
    preset-service-account: "true"
    preset-dind-enabled: "true"
spec:
    containers:
      # TODO: change to a custom image that embeds the system tools we
      # need (jq, make, bash, Go, etc) but without Bazel. Tracked at
      # https://github.com/cert-manager/cert-manager/issues/4939.
      - image: eu.gcr.io/jetstack-build-infra-images/bazelbuild:20210831-4cf7b0b-4.2.1
        args:
          - runner
          - bash
          - -c
          - |
            apt-get install jq -y >/dev/null
            make -j e2e-setup-kind && ./hack/verify-upgrade.sh
        resources:
          requests:
            cpu: 3500m
            memory: 12Gi
        securityContext:
          privileged: true
          capabilities:
            add: ["SYS_ADMIN"]
        volumeMounts:
          - mountPath: /lib/modules
            name: modules
            readOnly: true
          - mountPath: /sys/fs/cgroup
            name: cgroup
          - mountPath: /root/.cache/go-build
            name: gocache
          - mountPath: /home/prow/go/pkg/mod
            name: gopkgmod
          - mountPath: /home/prow/go/src/github.com/cert-manager/cert-manager/bin/downloaded
            name: bindownloaded
    volumes:
      - name: modules
        hostPath:
          path: /lib/modules
          type: Directory
      - name: cgroup
        hostPath:
          path: /sys/fs/cgroup
          type: Directory
      - name: gocache
        hostPath:
          path: /tmp/gocache
          type: DirectoryOrCreate
      - name: gopkgmod
        hostPath:
          path: /tmp/gopkgmod
          type: DirectoryOrCreate
      - name: bindownloaded
        hostPath:
          path: /tmp/bindownloaded
          type: DirectoryOrCreate
    dnsConfig:
      options:
        - name: ndots
          value: "1"
